<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Modern Chat</title>
  <style>
    body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; }
    .sidebar { width: 250px; background: #f0f0f0; padding: 1rem; overflow-y: auto; }
    .chat-container { flex: 1; display: flex; flex-direction: column; padding: 1rem; }
    .messages { flex: 1; border: 1px solid #ccc; padding: 1rem; overflow-y: auto; margin-bottom: 1rem; }
    .message { margin-bottom: 1rem; }
    .sender { font-weight: bold; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>Recent</h3>
    <div id="recent-users"></div>
    <input type="text" id="search" placeholder="Search users...">
    <div id="search-results"></div>
  </div>
  <div class="chat-container">
    <div class="messages" id="chat-box"></div>
    <form id="chat-form">
      <input type="hidden" id="receiver-id">
      <textarea id="chat-input" rows="3" style="width: 100%;"></textarea>
      <button type="submit">Send</button>
    </form>
  </div>

<script>
  let selectedUserId = null;

  async function loadConversation(userId) {
    selectedUserId = userId;
    document.getElementById('receiver-id').value = userId;

    const response = await fetch(`/messages/thread/${userId}`);
    const data = await response.json();
    const box = document.getElementById('chat-box');
    box.innerHTML = "";

    if (data.length === 0) {
      box.innerHTML = "<p>No messages yet.</p>";
      return;
    }

    data.forEach(msg => {
      const from = msg.sender.user_id === userId ? msg.sender.username : "You";
      box.innerHTML += `
        <div class='message'>
          <div class='sender'>${from}:</div>
          <div>${msg.content}</div>
          <small>${new Date(msg.timestamp).toLocaleString()}</small>
        </div>`;
    });

    box.scrollTop = box.scrollHeight;
  }

  async function loadRecentUsers() {
    const res = await fetch('/messages/recent-users');
    const data = await res.json();
    const container = document.getElementById('recent-users');
    container.innerHTML = "";

    data.forEach(user => {
      const btn = document.createElement('button');
      btn.textContent = user.username;
      btn.onclick = () => loadConversation(user.user_id);
      container.appendChild(btn);
    });
  }

  async function searchUsers(q) {
    const res = await fetch(`/messages/search-users?q=${encodeURIComponent(q)}`);
    const data = await res.json();
    const container = document.getElementById('search-results');
    container.innerHTML = "";

    data.forEach(user => {
      const btn = document.createElement('button');
      btn.textContent = user.username;
      btn.onclick = () => loadConversation(user.user_id);
      container.appendChild(btn);
    });
  }

  document.getElementById('search').addEventListener('input', (e) => {
    searchUsers(e.target.value);
  });

  document.getElementById('chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const receiver_id = document.getElementById('receiver-id').value;
    const content = document.getElementById('chat-input').value;

    if (!receiver_id || !content.trim()) return;

    await fetch('/messages/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ receiver_id, content })
    });

    document.getElementById('chat-input').value = "";
    await loadConversation(receiver_id);
  });

  // Initial load
  loadRecentUsers();
</script>

</body>
</html>
